
<!DOCTYPE html>
<html>
  <head>
    <title>Mapabilly</title>
    <link rel="stylesheet" href="mapabilly.css">
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember.js/1.5.1/ember.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember-data.js/1.0.0-beta.7/ember-data.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script>
      window.Mapp = Ember.Application.create();

      Mapp.ApplicationAdapter = DS.FixtureAdapter;

      Mapp.Store = DS.Store.extend({
        adapter: "DS.FixtureAdapter"
      });

      Mapp.Router.map(function() {
        this.resource("cats", { path: "/" });
      });

      Mapp.Cat = DS.Model.extend({
        // type: DS.belongsTo("animals.cats"),
        name: DS.attr("string"),
        longitude: DS.attr("number"),
        latitude: DS.attr("number"),
        info: function() {
          console.log("Cat: " + this.get("name") + ", Location: " + this.get("longitude") + " " + this.get("latitude"));
        }.property("name", "longitude", "latitude")
      });

      // Mapp.Animals = DS.Model.extend({
      //   cats: DS.hasMany("cat")
      // });

      Mapp.Cat.FIXTURES = [
        { id: 1, name: "KITTY", longitude: 37.752, latitude: -122.412872},
        { id: 2, name: "Belugastan", longitude: 37.751101, latitude: -122.412872}
      ];

      // Mapp.Router.map(function() {
      //   this.resource("animals");
      //   this.resource("animals.cats", { path: ":cat_id" });
      // });

      // Mapp.AnimalsRoute = Ember.Route.extend({
      //   model: function() {
      //     return this.store.all("cats");
      //   }
      // });

      Mapp.CatsRoute = Ember.Route.extend({
        model: function() {
          return this.store.find("cat");
        }
      });

      Mapp.AnimalsController = Ember.ArrayController.extend({
        // catsList: function() {
        //   // var cats = this.get("model.cats");
        //   var cats = "cats";
        //   console.log("CATS: " + cats);
        //   return cats;
        //   // for (var cat in cats) {
        //   //   console.log("cat: " + cat.name);
        //   // }
        // }
      });

      Mapp.CatRoute = Ember.Route.extend({
        // model: function(params) {
        //   return this.store.find("cat", params.cat_id);
        // }
        model: function() {
          return this.store.find("cat", 1);
        }
      });

      Mapp.MapView = Ember.View.extend({
        classNames: ["mapp"],
        markers: [
          [37.752, -122.412872, "CAT"],
          [37.751101, -122.412872, "Belugastan"]
        ],

        didInsertElement: function() {
          var cats = this.get("controller.catsList");
          // var cats = this.get("controller").get("catsList");
          // var cats = Mapp.MapController.get("catsList");
          console.log("CATS? " + cats);
          this.$().css({ width: "700px", height: "500px" });
          var center = new google.maps.LatLng(this.get("latitude"),this.get("longitude"));
          var mapOptions = {
            zoom: 15,
            center: center,
            scaleControl: true,
            zoomControl: true,
            zoomControlOptions: {
              style: google.maps.ZoomControlStyle.SMALL
            },
            panControl: true,
            mapTypeId: google.maps.MapTypeId.HYBRID
          };
          var map = new google.maps.Map(this.$()[0], mapOptions);

          var markers = this.get("markers");
          var googleMarkers = [];

          function addMarker(title, position, content) {
            var marker = new google.maps.Marker({
              position: position,
              map: map,
              title: title,
              draggable: false
            });
            var infowindow = new google.maps.InfoWindow({
              content: content
            });
            googleMarkers.push(marker);
            google.maps.event.addListener(marker, 'click', function(event) {
              infowindow.open(map,marker);
            });            
          };

          for (i = 0; i < markers.length; i++) {
            console.log(markers[i][0], markers[i][1], markers[i][2]);
            var position = new google.maps.LatLng(markers[i][0], markers[i][1]);
            var content = markers[i][2];
            addMarker(content, position, content);
          }
        },

        willDestroyElement: function() {
          for (i in googleMarkers) {
            google.maps.event.clearInstanceListeners(googleMarkers[i]);
            console.log("clear listeners");
          }
        }
      });

      Mapp.ApplicationController = Ember.Controller.extend({
        catsList: "cats"
        // catsList: this.get("animals.cats")
        // actions: {
        // catsList: function() {
        //   // var cats = this.modelFor("animals").get("cats");
        //   var cats = "cats!";
        //   console.log("CATS: " + cats);
        //   return cats;
        //   // for (var cat in cats) {
        //   //   console.log("cat: " + cat.name);
        //   // }
        // }          
        // }
      });

      Mapp.MapInputView = Ember.View.extend({
        templateName: "map-input",
        classNames: ["map-input"],
      });

      Mapp.MapInputController = Ember.Controller.extend({
        actions: {
          submit: function() {
            var name = this.get("name");
            var latitude = this.get("latitude");
            var longitude = this.get("longitude");
            console.log("CatInputController submit - name: " + name + ", latitude: " + latitude+ ", longitude: " + longitude);
          }
        }
      });
    </script>
  </head>
  <body>
    
    <script type="text/x-handlebars">
      {{view Mapp.MapView latitude="37.751101" longitude="-122.412872"}}
      {{render "map-input"}}
    </script>

    <script type="text/x-handlebars" data-template-name="map-input">
      {{input type="text" value=name placeholder="Name"}}
      {{input type="text" value=latitude placeholder="Latitude"}}
      {{input type="text" value=longitude placeholder="Longitude"}}
      <button {{action "submit" this}}>Add</button>
    </script>

  </body>
</html>