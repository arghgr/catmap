
<!DOCTYPE html>
<html>
  <head>
    <title>Mapabilly</title>
    <link rel="stylesheet" href="mapabilly.css">
  </head>
  <body>

    <script type="text/x-handlebars">
      {{#link-to "cats"}}cats{{/link-to}}
      {{#link-to "map"}}map{{/link-to}}
      {{outlet}}
    </script>
    <script type="text/x-handlebars" data-template-name="cats">
      <div class="cats">
        <h2>cats: {{catCount}}</h2>
        <ul>
        {{#each itemController="cat"}}
          <li {{bind-attr class="isEditing:editing"}}>
            {{#if isEditing}}
              {{input type="text" value=catName placeholder=name}}
              <br>{{input type="text" value=catLongitude placeholder=longitude}}
              <br>{{input type="text" value=catLatitude placeholder=latitude}}
              <br><button {{action "cancel"}}>cancel</button>
              <button {{action "saveCat"}}>save changes</button>
            {{else}}
              name: {{name}}
              <br>longitude: {{longitude}}
              <br>latitude: {{latitude}}
              <br><button {{action "editCat"}}>edit cat</button>
              <button {{action "removeCat"}}>remove cat</button>
            {{/if}}
          </li>
        {{/each}}
        </ul>
      </div>
      <div class="new-cat">
        {{input type="text" class="new-cat-input" placeholder="name" value=newCatName}}
        {{input type="text" class="new-cat-input" placeholder="longitude" value=newCatLongitude}}
        {{input type="text" class="new-cat-input" placeholder="latitude" value=newCatLatitude}}
        <button {{action "submit"}}>add cat</button>
      </div>
    </script>


    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember.js/1.5.1/ember.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember-data.js/1.0.0-beta.7/ember-data.js"></script>
    <script>
      window.Mapp = Ember.Application.create();

      Mapp.ApplicationAdapter = DS.FixtureAdapter;

      Mapp.Store = DS.Store.extend({
        adapter: "DS.FixtureAdapter"
      });

      Mapp.Router.map(function() {
        this.resource("cats");
        this.resource("map");
      });

      Mapp.Cat = DS.Model.extend({
        name: DS.attr("string"),
        longitude: DS.attr("number"),
        latitude: DS.attr("number")
      });

      Mapp.Cat.FIXTURES = [
        {
          id: 1,
          name: "KITTY",
          latitude: 37.752,
          longitude: -122.412872
        },
        { id: 2,
          name: "Belugastan",
          latitude: 37.751101,
          longitude: -122.412872
        },
        { id: 3,
          name: "dignified tabby",
          latitude: 37.751689,
          longitude: -122.41292
        }
      ];

      Mapp.CatsRoute = Ember.Route.extend({
        model: function() {
          return this.store.find("cat");
        }
      });

      Mapp.CatsController = Ember.ArrayController.extend({
        catCount: function() {
          return this.get("length");
        }.property("@each"),

        actions: {
          submit: function() {
            var name = this.get("newCatName");
            var longitude = this.get("newCatLongitude");
            var latitude = this.get("newCatLatitude");

            if (!Ember.isEmpty(name) && !Ember.isEmpty(longitude) && !Ember.isEmpty(latitude)) {
              var cat = this.store.createRecord("cat", {
                name: name,
                longitude: longitude,
                latitude: latitude
              });

              this.set("newCatName", "");
              this.set("newCatLongitude", "");
              this.set("newCatLatitude", "");

              cat.save();
            } else {
              alert("not enough info");
            }
          }
        }
      });

      Mapp.CatController = Ember.ObjectController.extend({
        isEditing: false,
        actions: {
          editCat: function() {
            this.set("isEditing", true);
          },
          saveCat: function() {
            this.set("isEditing", false);

            var name = this.get("catName");
            var longitude = this.get("catLongitude");
            var latitude = this.get("catLatitude");
            if (!Ember.isEmpty(name)) this.get("model").set("name", name);
            if (!Ember.isEmpty(longitude)) this.get("model").set("longitude", longitude);
            if (!Ember.isEmpty(latitude)) this.get("model").set("latitude", latitude);

            this.get("model").save();
          },
          cancel: function() {
            this.set("isEditing", false);
            this.set("catName", "");
            this.set("catLongitude", "");
            this.set("newCatLatitude", "");
          },
          removeCat: function() {
            var cat = this.get("model");
            cat.deleteRecord();
            cat.save();
          }
        }
      });

      Mapp.MapView = Ember.View.extend({
        classNames: ["mapp"],
        map: null,
        latitude: 37.751101,
        longitude: -122.412872,
        attributeBindings: ["style"],
        style: "height: 500px; width: 700px;",
        markers: [
          [37.752, -122.412872, "CAT"],
          [37.751101, -122.412872, "Belugastan"]
        ],

        initializeMap: function() {
          this.$().css({ width: "700px", height: "500px" });
          var center = new google.maps.LatLng(this.get("latitude"),this.get("longitude"));
          var mapOptions = {
            zoom: 15,
            center: center,
            scaleControl: true,
            zoomControl: true,
            zoomControlOptions: {
              style: google.maps.ZoomControlStyle.SMALL
            },
            panControl: true,
            mapTypeId: google.maps.MapTypeId.HYBRID
          };
          var map = new google.maps.Map(this.$()[0], mapOptions);
          this.set("map", map);
        },
        loadScript: function() {
          var self = this;
          window.initialize = function() {
            self.initializeMap();
          }
          $.getScript("https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&callback=initialize");
        },

        // loadScript: function() {
        //   var self = this;
        //   $.getScript("https://www.google.com/jsapi", function() {
        //     google.load("maps", "3", {
        //       other_params: "sensor=false",
        //       callback: function() { self.initializeMap(); }
        //     });
        //   });
        // },

        didInsertElement: function() {
          this._super();
          // this.loadScript();
          Ember.run.later(this, function() {
            this.loadScript();
          }, 1000);
        }

        // didInsertElement: function() {
        //   this.$().css({ width: "700px", height: "500px" });
        //   var center = new google.maps.LatLng(this.get("latitude"),this.get("longitude"));
        //   var mapOptions = {
        //     zoom: 15,
        //     center: center,
        //     scaleControl: true,
        //     zoomControl: true,
        //     zoomControlOptions: {
        //       style: google.maps.ZoomControlStyle.SMALL
        //     },
        //     panControl: true,
        //     mapTypeId: google.maps.MapTypeId.HYBRID
        //   };
        //   var map = new google.maps.Map(this.$()[0], mapOptions);
        //   this.set("map", map);
          // var markers = this.get("markers");
          // var googleMarkers = [];

          // function addMarker(title, position, content) {
          //   var marker = new google.maps.Marker({
          //     position: position,
          //     map: map,
          //     title: title,
          //     draggable: false
          //   });
          //   var infowindow = new google.maps.InfoWindow({
          //     content: content
          //   });
          //   googleMarkers.push(marker);
          //   google.maps.event.addListener(marker, 'click', function(event) {
          //     infowindow.open(map,marker);
          //   });            
          // };

          // for (i = 0; i < markers.length; i++) {
          //   console.log(markers[i][0], markers[i][1], markers[i][2]);
          //   var position = new google.maps.LatLng(markers[i][0], markers[i][1]);
          //   var content = markers[i][2];
          //   addMarker(content, position, content);
          // }
        // },

        // willDestroyElement: function() {
        //   for (i in googleMarkers) {
        //     google.maps.event.clearInstanceListeners(googleMarkers[i]);
        //     console.log("clear listeners");
        //   }
        // }
      });

    </script>
  </body>
</html>