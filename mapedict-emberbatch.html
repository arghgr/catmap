
<!DOCTYPE html>
<html>
  <head>
    <title>Mapabilly</title>
    <link rel="stylesheet" href="mapabilly.css">
  </head>
  <body>

    <script type="text/x-handlebars" data-template-name="index">
      <div class="index-map">
        {{render "map" this}}
      </div>
      <div class="index-cats">
        {{render "cats" this}}
      </div>

    </script>

    <script type="text/x-handlebars" data-template-name="cats">
      <div class="cats">
        <h2>cats: {{catCount}}</h2>
        <ul>
        {{#each}}
          {{render "cat" this}}
        {{/each}}
        </ul>
      </div>
      <div class="new-cat">
        {{input type="text" class="new-cat-input" placeholder="name" value=newCatName}}
        {{input type="text" class="new-cat-input" placeholder="latitude" value=newCatLatitude}}
        {{input type="text" class="new-cat-input" placeholder="longitude" value=newCatLongitude}}
        <button {{action "submit"}}>add cat</button>
      </div>
    </script>

    <script type="text/x-handlebars" data-template-name="cat">
      <li {{bind-attr class="isEditing:editing"}}>
        {{#if isEditing}}
          {{input type="text" value=catName placeholder=name}}
          <br>{{input type="text" value=catLatitude placeholder=latitude}}
          <br>{{input type="text" value=catLongitude placeholder=longitude}}
          <br><button {{action "cancel"}}>cancel</button>
          <button {{action "saveCat"}}>save changes</button>
        {{else}}
          name: {{name}}
          <br>id: {{id}}
          <br>latitude: {{latitude}}
          <br>longitude: {{longitude}}
          <br><button {{action "editCat"}}>edit cat</button>
          <button {{action "removeCat"}}>remove cat</button>
        {{/if}}
      </li>
    </script>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember.js/1.5.1/ember.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ember-data.js/1.0.0-beta.7/ember-data.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>
      window.Mapp = Ember.Application.create({
        LOG_ACTIVE_GENERATION: true,
        LOG_VIEW_LOOKUPS: true,
        LOG_TRANSITIONS: true,
        LOG_TRANSITIONS_INTERNAL: true
      });

      Mapp.ApplicationAdapter = DS.FixtureAdapter;

      Mapp.Store = DS.Store.extend({
        adapter: "DS.FixtureAdapter"
      });

      Mapp.Router.map(function() {
        this.route("index", { path: "/" }, function() {
          this.resource("cats");
          this.resource("map");
        });
      });

      Mapp.Cat = DS.Model.extend({
        name: DS.attr("string"),
        longitude: DS.attr("number"),
        latitude: DS.attr("number"),
        species: DS.belongsTo("cats", { inverse: "cats" })
      });

      Mapp.Cats = DS.Model.extend({
        cats: DS.hasMany("cat", { inverse: "species" }),
        hasCats: function() {
          kits = this.get("cats");
          console.log("woah " + this.get("cats"));
          return kits.then(function(kitties) {
            console.log("cats model: " + kitties);
            return kitties;
          });
        }.property("cats")
      });

      Mapp.Cat.FIXTURES = [
        {
          id: 1,
          name: "KITTY",
          latitude: 37.752,
          longitude: -122.412872
        },
        { id: 2,
          name: "Belugastan",
          latitude: 37.751101,
          longitude: -122.412872
        },
        { id: 3,
          name: "dignified tabby",
          latitude: 37.751689,
          longitude: -122.41292
        }
      ];

      Mapp.IndexRoute = Ember.Route.extend({
        model: function() {
          return this.store.find("cat");
        }
      });

      Mapp.CatsController = Ember.ArrayController.extend({
        needs: ["map"],
        catCount: function() {
          return this.get("length");
        }.property("@each"),

        actions: {
          submit: function() {
            var name = this.get("newCatName");
            var longitude = this.get("newCatLongitude");
            var latitude = this.get("newCatLatitude");

            if (!Ember.isEmpty(name) && !Ember.isEmpty(longitude) && !Ember.isEmpty(latitude)) {
              var cat = this.store.createRecord("cat", {
                name: name,
                longitude: longitude,
                latitude: latitude
              });

              this.set("newCatName", "");
              this.set("newCatLongitude", "");
              this.set("newCatLatitude", "");

              var self = this;
              cat.save().then(function(savedCat) {
                var id = savedCat.get("id");
                console.log("new cat id: " + id);
                console.log("cat map object: " + self.get("controllers.map.map"));
                self.get("controllers.map").addMarker(id, name, latitude, longitude);
              });
            } else {
              alert("not enough info");
            }
          }
        }
      });

      Mapp.CatController = Ember.ObjectController.extend({
        needs: ["map"],
        isEditing: false,
        actions: {
          editCat: function() {
            this.set("isEditing", true);
          },
          saveCat: function() {
            this.set("isEditing", false);

            var name = this.get("catName");
            var longitude = this.get("catLongitude");
            var latitude = this.get("catLatitude");
            if (!Ember.isEmpty(name)) this.get("model").set("name", name);
            if (!Ember.isEmpty(longitude)) this.get("model").set("longitude", longitude);
            if (!Ember.isEmpty(latitude)) this.get("model").set("latitude", latitude);

            this.get("model").save();
          },
          cancel: function() {
            this.set("isEditing", false);
            this.set("catName", "");
            this.set("catLongitude", "");
            this.set("newCatLatitude", "");
          },
          removeCat: function() {
            var cat = this.get("model");
            this.get("controllers.map").removeMarker(cat.get("id"));
            cat.deleteRecord();
            cat.save();
          }
        }
      });

      Mapp.MapController = Ember.ArrayController.extend({
        markers: [],
        map: null,
        latitude: 37.751101,
        longitude: -122.412872,
        infowindow: null,

        getCats: function() {
          var catStore = this.get("store").find("cat");
          return catStore.then(function(cats) {
            return cats;
          });
        },
        addMarker: function(id, name, latitude, longitude) {
          console.log("OMG KITTY");
          var self = this;
          console.log("addMarker self: " + self);
          Ember.run.next(function() {
            console.log("addMarker this: " + this);
            var map = window.map;
            var markers = self.get("markers");
            var bindInfowindow = self.get("bindInfowindow");
            var cats = self.getCats();
            cats.then(function(kitties) {
              if (map) {
                if (!markers.findBy("title", id)) {
                  var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(latitude, longitude),
                    map: map,
                    title: id,
                    draggable: false
                  });
                  markers.push(marker);
                  bindInfowindow(marker, name, self);
                } else {
                  console.log("marker already exists with title (id): " + id);
                }
              } else {
                console.log("no map");
              }
            });
          });
        },
        removeMarker: function(id) {
          console.log("remove marker: " + id);
          var markers = this.get("markers");
          console.log("markers: ");
          markers.map(function(marker) {
            console.log(marker.get("title") + "!");
          });
          var markerSearch = markers.filterProperty("title", id);
          if (markerSearch) {
            console.log("removing marker: " + markerSearch[0].get("title"));
            markerSearch[0].setMap(null);
          } else {
            console.log("no marker to remove");
          }
        },
        bindInfowindow: function(marker, content, scope) {
          console.log("bindInfowindow scope: " + scope);
          google.maps.event.addListener(marker, 'click', function(event) {
            var map = this.get("map");
            var infowindow = scope.get("infowindow");
            console.log("bindInfowindow infowindow: " + infowindow);
            if (infowindow) infowindow.close();
            infowindow = new google.maps.InfoWindow({ content: content });
            scope.set("infowindow", infowindow);
            infowindow.open(map,marker);
          });
        }
      });

      Mapp.MapView = Ember.View.extend({
        classNames: ["mapp"],

        initializeMap: function(scope) {
          var controller = scope.get("controller");
          console.log("map initialize " + controller);
          var center = new google.maps.LatLng(
            controller.get("latitude"),
            controller.get("longitude")
          );
          var mapOptions = {
            zoom: 16,
            center: center,
            scaleControl: true,
            zoomControl: true,
            zoomControlOptions: {
              style: google.maps.ZoomControlStyle.SMALL
            },
            panControl: true,
            mapTypeId: google.maps.MapTypeId.HYBRID
          };
          var self = scope;
          var map = new google.maps.Map(scope.$()[0], mapOptions);
          google.maps.event.addListener(map, "click", function(){
            var infowindow = controller.get("infowindow");
            if (infowindow) infowindow.close();
          });
          self.set("controller.map", map);
          window.map = map;
          self.addMarkers();
          return map;
        },

        addMarkers: function() {
          var self = this;
          var controller = this.get("controller");
          var map = controller.get("map");
          console.log("addMarkers map: " + map);
          var markers = controller.get("markers");
          var bindInfowindow = controller.get("bindInfowindow");
          var catStore = controller.getCats();
          catStore.then(function(cats) {
            cats.forEach(function(cat) {
              var id = cat.get("id");
              var latitude = cat.get("latitude");
              var longitude = cat.get("longitude");
              var name = cat.get("name").toString();
              var position = new google.maps.LatLng(latitude, longitude);
              var marker = new google.maps.Marker({
                position: position,
                map: map,
                title: id,
                draggable: false
              });
              markers.push(marker);
              bindInfowindow(marker, name, self);
            });
          });
        },

        loadMaps: function(callback) {
          google.load("maps", 3, { "callback": callback });
        },

        willInsertElement: function() {
          var self = this;
          window.initialize = function() {
            self.initializeMap(self);
            google.maps.event.addListener(window.map, "click", function(){
              var infowindow = self.get("infowindow");
              if (infowindow) infowindow.close();
            });
          }
          this.loadMaps(initialize);
        },

        willDestroyElement: function() {
          var map = this.get("controller.map");
          var markers = this.get("controller.markers");
          for (i = 0; i < markers.length; i++) {
            google.maps.event.clearInstanceListeners(markers[i]);
          }
          google.maps.event.clearInstanceListeners(map);
          if (window.map) { delete window.map; }
        }
      });

    </script>
  </body>
</html>